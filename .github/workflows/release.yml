name: CI & Release
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 7
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
          scope: '@airqo-icons'

      - name: Configure NPM
        run: |
          echo "@airqo-icons:registry=https://registry.npmjs.org/" > ~/.npmrc
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc
          npm whoami

      - name: Install dependencies
        run: pnpm install
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create output directories
        run: |
          mkdir -p packages/react/src/icons
          mkdir -p packages/react-native/src/icons
          mkdir -p packages/flutter/assets
          mkdir -p packages/vue/src/icons
          mkdir -p packages/core/src

      - name: Optimize SVGs
        run: |
          echo "Running SVG optimization..."
          pnpm run optimize

      - name: Generate Icons
        run: |
          echo "Generating icons..."
          node scripts/generate-icons.js
          echo "Verifying generated files..."
          ls -la packages/react-native/src/icons || echo "Icons not generated in react-native"
          ls -la packages/react/src/icons || echo "Icons not generated in react"

      - name: Build Core Package
        run: |
          cd packages/core
          pnpm run build

      - name: Build All Packages
        run: pnpm run build

      - name: Debug Build Failure (if occurs)
        if: failure()
        run: |
          echo "=== Build failed, showing diagnostic information ==="
          echo "=== Directory structure ==="
          ls -R packages/
          echo "=== Package versions ==="
          pnpm list
          echo "=== Checking for error patterns ==="
          find packages -name "*.log" -exec cat {} \; 2>/dev/null || echo "No log files found"
          echo "=== React Native index.ts ==="
          if [ -f "packages/react-native/src/index.ts" ]; then
            cat packages/react-native/src/index.ts
          fi
          echo "=== React index.ts ==="
          if [ -f "packages/react/src/index.ts" ]; then
            cat packages/react/src/index.ts
          fi

      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.7.0'

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 7
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
          scope: '@airqo-icons'

      - name: Configure Git User
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
      - name: Configure NPM
        run: |
          echo "@airqo-icons:registry=https://registry.npmjs.org/" > ~/.npmrc
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc
          npm config set access public
          npm whoami

      - name: Install dependencies
        run: pnpm install
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create output directories
        run: |
          mkdir -p packages/react/src/icons
          mkdir -p packages/react-native/src/icons
          mkdir -p packages/flutter/assets
          mkdir -p packages/vue/src/icons
          mkdir -p packages/core/src

      - name: Generate Icons and Build
        run: |
          pnpm run optimize
          node scripts/generate-icons.js
          pnpm run build

      - name: Run Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm whoami
          npx semantic-release --debug

      - name: Debug Publishing (if failure)
        if: failure()
        run: |
          echo "=== Semantic Release failed, showing diagnostic information ==="
          echo "NPM Config:"
          npm config list
          echo "=== Checking NPM user:"
          npm whoami || echo "Not logged in to NPM"

      - name: Setup Flutter SDK for publish
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.7.0'

      - name: Publish Flutter package to pub.dev
        if: env.PUB_DEV_TOKEN != ''
        env:
          PUB_DEV_TOKEN: ${{ secrets.PUB_DEV_TOKEN }}
        run: |
          cd packages/flutter
          flutter pub get
          mkdir -p ~/.pub-cache
          echo '{"https://pub.dev":{"token":"'$PUB_DEV_TOKEN'"}}' > ~/.pub-cache/credentials.json
          flutter pub publish --force
