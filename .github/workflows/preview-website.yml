# .github/workflows/preview-website.yml
name: Preview Documentation Website

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'website/**'
      - 'svgs/**'
      - 'packages/core/**'
      - 'packages/react/**'
      - '.github/workflows/preview-website.yml'

jobs:
  preview:
    name: Build Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org/

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 8.10.0
          run_install: false

      # Explicitly set shell environment variable
      - name: Set shell environment
        run: echo "SHELL=/bin/bash" >> $GITHUB_ENV

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup PNPM cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Generate Icons
        run: pnpm generate

      - name: Fix component types
        run: pnpm fix-component-types

      - name: Enhance React Native Icons
        run: pnpm enhance-rn

      - name: Build website
        run: |
          echo "Building website preview with static export..."
          NODE_ENV=production pnpm static:website

      - name: Upload website build artifact
        uses: actions/upload-artifact@v3
        with:
          name: website-preview
          path: ./website/out
          retention-days: 7

      - name: Add PR comment with preview info
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-website
          message: |
            # ��� Website Preview

            A preview of the documentation website has been generated for this pull request.

            ��� **Preview Build**: You can download the preview build from the artifacts section of this workflow.

            ## How to View the Preview

            1. Go to the Actions tab of this PR
            2. Click on this workflow ("Preview Documentation Website")
            3. Scroll down to "Artifacts" and download the "website-preview" zip file
            4. Extract the files and open index.html in your browser

            _This preview will be available for 7 days or until a new commit is pushed to this PR._

      - name: Preview Build Status
        if: success()
        run: |
          echo "### Website Preview Build successful ✅" >> $GITHUB_STEP_SUMMARY
          echo "The preview website was successfully built and is available as an artifact." >> $GITHUB_STEP_SUMMARY
